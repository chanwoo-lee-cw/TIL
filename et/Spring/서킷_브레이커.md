# 서킷 브레이커

## 서킷 브레이커란?

### 본래 사전적 정의

> 주가의 급격한 변동으로 주식시장의 붕괴를 막기 위해, 주가가 지나치게 폭락을 하게 되면 거래를 정면 중단하는 제도이다.



### 개발적인 의미

> 서킷브레이커는 서로 다른 시스템 간의 연동 시 장애전파 차단을 목적으로 합니다. 연동 시 이상을 감지하고 이상이 발생하면 연동을 차단하고, 이후 이상이 회복되면 자동으로 다시 연동하기 위한 기술

즉, 시스템의 안정성의 향상을 위해 사용한다. 분리된 서비스 간 통신에서 발생 가능한 장애 상황을 관리하고, 다른 서비스 장애가 시스템 전체로 확산되지 못하도록 막기 위해 사용한다.



## 서킷 브레이커의 동작 방식

![서킷 브레이커](https://velog.velcdn.com/images/alphanewbie/post/b4e22235-7224-43d7-b033-60b154afda98/image.png)

- **CLOSED(정상 상태)**
  - 모든 요청이 정상적으로 처리된다. 만약 요청이 실패하면 실패 횟수가 기록된다.
  - 실패 횟수가 사전에 정의된 임계치에 도달하면 서킷 브레이커는 Open상태로 전환된다.
- **OPEN(요청 차단)**
  - 이 상태에서는 요청이 즉시 실패로 처리되고, 서비스 호출이 계속 차단된다.
  - 이 상태는 일정기간 지속된다.
- **HALF_OPEN(일부 요청만 허용)**
  - Open 상태로 일정 시간 후에, 서킷 브레이커는 일부 요청을 허용하여 서비스가 복구되었는지 확인한다.
  - 작업을 호출하는데 성공한 시도 횟수를 기록한다.
    - 지정된 수의 연속 성공 후에 Closed 상태로 돌아간다.
    - 실패하면 Open 상태로 돌아가서 성공 카운터가 초기화된다.



## 문제 및 고려 사항

- **예외 처리** : 
  - 서킷 브레이커를 통해 작업을 호출하는 어플리케이션은 작업을 사용할 수 없는 경우 풀백 매커니즘을 제공해서 동일한 작업을 수행하거나, 동일한 데이터를 가져오거나 사용자에게 예외를 보고하고 나중에 다시 시도하도록 요청할 수 있다.
- **예외 유형** : 
  - 요청 실패의 원인은 심각도에 따라 달라질 수 있다. 서킷 브레이커는 예외 유형을 검사하고 이러한 특성에 따라 전략을 조정할 수 있다. 예를 들어 회로 차단기를 Open 상태로 트리거하려면 사용할 수 없는 서비스로 인한 오류 수에 비해 더 많은 시간 제한 예외가 필요할 수 있다.
- **모니터링:** 
  - 회로 차단기는 운영 팀이 시스템 상태를 평가할 수 있도록 실패한 요청과 성공적인 요청 모두에 대한 명확한 관찰 가능성을 제공해야 한다. 서비스 전반에서 엔드 투 엔드 가시성을 위해 분산 추적을 사용한다.



## 서킷 브레이커 말고 가용성을 위한 선택





## 서킷 브레이커의 적용

### 참고 사항

가장 자주 쓰이는 서킷 브레이너는 [Netflix-Hystrix](https://github.com/Netflix/Hystrix)와 [resilience4j](https://github.com/resilience4j/resilience4j) 이렇게 2가지가 자주 쓰인다.

나는 그 중에서 resilience4j를 사용해보기로 했는데, 그 이유는

1. 업데이트
   - Netflix-Hystrix : 2018년 이후로 업데이트가 멈춰있었다.
   - resilience4j :  올해까지 업데이트가 되어있었다.
2. 구현의 차이
   - Netflix-Hystrix: 외부 시스템 호출을 반드시 `HystrixCommand`라는 클래스로 감싸야한다.
   - resilience4j : 데코레이터 개념을 활용함으로써 기존 함수에 서킷 브레이커 기능을 덧씌우는게 가능하다.

하지만 주의 사항으로 Java 17 이상이 필요하다.



### 주로 참고한 문서

https://oliveyoung.tech/2023-08-31/circuitbreaker-inventory-squad/



### Gradle 설정

```
val resilience4jVersion = "2.2.0"

dependencies {
	implementation("org.springframework.boot:spring-boot-starter-actuator")
	
	// resilience4j
	// 1. CircuitBreaker : 기본 기능
	implementation("io.github.resilience4j:resilience4j-circuitbreaker:${resilience4j}")
	// 2. @CircuitBreaker, @Retry 등 애노테이션 제공 (메서드 단위 적용 시 필요)
	implementation("io.github.resilience4j:resilience4j-annotations:${resilience4j}")
	// 3) Spring Boot 3 : 자동 구성(AutoConfig) + AOP 어드바이스 연동 + 프로퍼티 바인딩 + application.yml 설정
	implementation("io.github.resilience4j:resilience4j-spring-boot3:${resilience4j}")
	// 4. Retry : 요청 실패 시 재시도 처리 기능
	implementation("io.github.resilience4j:resilience4j-retry:${resilience4j}")
	// 5. RateLimiter : 제한치를 넘어서 요청을 거부하거나 Queue 생성하여 처리하는 기능
	implementation("io.github.resilience4j:resilience4j-ratelimiter:${resilience4j}")
	// 6. TimeLimiter : 실행 시간제한 설정 기능
	implementation("io.github.resilience4j:resilience4j-timelimiter:${resilience4j}")
	// 7. Bulkhead : 동시 실행 횟수 제한 기능
	implementation("io.github.resilience4j:resilience4j-bulkhead:${resilience4j}")
	// 8. Cache : 결과 캐싱 기능
	implementation("io.github.resilience4j:resilience4j-cache:${resilience4j}")
}
```

이런 의존성이 있지만, 필요한 것 갖다 쓰면 된다.



```
dependencies {
		implementation("org.springframework.boot:spring-boot-starter-actuator")
		
		// resilience4j
		implementation("io.github.resilience4j:resilience4j-circuitbreaker:${resilience4j}")
		implementation("io.github.resilience4j:resilience4j-annotations:${resilience4j}")
		implementation("io.github.resilience4j:resilience4j-spring-boot3:${resilience4j}")
}
```

다만, 이번 예제에서는 Spring에 서킷 브레이커를 쓰는데 필요한 의존성인 4개만 가져다 사용한다.



### 환경 변수

```yaml
# application-test.yml 
resilience4j:
  circuitbreaker:
    failure-rate-threshold: 10   # 실패 10% 이상 시 서킷 오픈
    slow-call-duration-threshold: 500   # 500ms 이상 소요 시 실패로 간주
    slow-call-rate-threshold: 10   # slowCallDurationThreshold 초과 비율이 10% 이상 시 서킷 오픈
    wait-duration-in-open-state: 30000   # OPEN -> HALF-OPEN 전환 전 기다리는 시간
    minimum-number-of-calls: 50   # 집계에 필요한 최소 호출 수
    sliding-window-size: 100   # 서킷 CLOSE 상태에서 N회 호출 도달 시 failureRateThreshold 실패 비율 계산
    permitted-number-of-calls-in-half-open-state: 30   # HALFOPEN -> CLOSE or OPEN 으로 판단하기 위해 호출 횟수
```

`CircuitBreakerProperty`에서 사용할 환경 변수를 작성해준다



### Config

```kotlin
// com/example/demo/common/config/circuitBreaker/CircuitBreakerProperty.kt
import org.springframework.boot.context.properties.ConfigurationProperties
import org.springframework.context.annotation.Configuration

@ConfigurationProperties(prefix = "resilience4j.circuitbreaker")
data class CircuitBreakerProperty(
    val failureRateThreshold: Float,
    val slowCallDurationThreshold: Long,
    val slowCallRateThreshold: Float,
    val waitDurationInOpenState: Long,
    val minimumNumberOfCalls: Int,
    val slidingWindowSize: Int,
    val permittedNumberOfCallsInHalfOpenState: Int,
)
```

`yml`에 작성한 환경 변수를 얻어와서 사용한다.



```kotlin
// com/example/demo/common/config/circuitBreaker/CircuitBreakerConfiguration.kt
import io.github.resilience4j.circuitbreaker.CircuitBreaker
import io.github.resilience4j.circuitbreaker.CircuitBreakerConfig
import io.github.resilience4j.circuitbreaker.CircuitBreakerRegistry
import org.springframework.context.annotation.Bean
import org.springframework.context.annotation.Configuration
import java.time.Duration

@Configuration
class CircuitBreakerConfiguration(
    val circuitBreakerProperty: CircuitBreakerProperty
) {

    companion object {
        // 관리할 서킷 브레이커 이름
        const val CB_TEST: String = "CB_TEST"
    }

    @Bean
    fun circuitBreakerRegistry(): CircuitBreakerRegistry {
        return CircuitBreakerRegistry.ofDefaults()
    }

    /**
     * 기본 서킷 브레이커 설정
     */
    @Bean
    fun circuitBreakerConfig(): CircuitBreakerConfig {
        return CircuitBreakerConfig.custom()
            .failureRateThreshold(circuitBreakerProperty.failureRateThreshold)
            .slowCallDurationThreshold(Duration.ofMillis(circuitBreakerProperty.slowCallDurationThreshold))
            .slowCallRateThreshold(circuitBreakerProperty.slowCallRateThreshold)
            .waitDurationInOpenState(Duration.ofMillis(circuitBreakerProperty.waitDurationInOpenState))
            .minimumNumberOfCalls(circuitBreakerProperty.minimumNumberOfCalls)
            .slidingWindowSize(circuitBreakerProperty.slidingWindowSize)
            .ignoreExceptions(RuntimeException::class.java)   // 화이트리스트로 서킷 오픈 기준 관리
            .permittedNumberOfCallsInHalfOpenState(circuitBreakerProperty.permittedNumberOfCallsInHalfOpenState)
            .build()
    }

    
    /**
     * 서킷 브레이커 테스트 전용으로 사용할 서킷 브레이커
     */
    @Bean
    fun testCircuitBreaker(
        circuitBreakerRegistry: CircuitBreakerRegistry
    ): CircuitBreaker {
        val defaultCircuitBreakerConfig = circuitBreakerConfig()
        return circuitBreakerRegistry.circuitBreaker(
            CB_TEST,
            CircuitBreakerConfig
                .from(defaultCircuitBreakerConfig)
                .apply {
                    CircuitBreakerConfig.custom()
                        .failureRateThreshold(circuitBreakerProperty.failureRateThreshold)
                }
                .build()
        )
    }
}
```





### Service

이 위까지가 서킷 브레이커 설정을 하는 부분이고, 이제 실제로 서킷 브레이커를 사용하는 부분을 작성한다.

```kotlin
package com.example.demo.service

import com.example.demo.common.config.circuitBreaker.CircuitBreakerConfiguration
import io.github.resilience4j.circuitbreaker.annotation.CircuitBreaker
import mu.KotlinLogging
import org.springframework.stereotype.Service

@Service
class CircuitBreakerService {

    private val logger = KotlinLogging.logger {}

    @CircuitBreaker(name = CircuitBreakerConfiguration.CB_TEST, fallbackMethod = "cbTestFallbackMethod")
    fun circuitBreakerTest(value: Boolean): Boolean {
        return when (value) {
            true -> true
            false -> throw RuntimeException("에러 발생")
        }
    }


    /**
     * fallbackMethod를 "cbTestFallbackMethod" 해놓은 메소드에서  RuntimeException 예외가 발생하면 이곳에서 처리한다.
     */
    fun cbTestFallbackMethod(
        value: Boolean,
        exception: RuntimeException
    ): Boolean {
        logger.info("${exception.message} 서킷 브레이커 작동")
        return when (value) {
            true -> true
            false -> false
        }
    }

  
    /**
     * fallbackMethod를 "cbTestFallbackMethod" 해놓은 메소드에서  Exception 예외가 발생하면 이곳에서 처리한다.
     */
    fun cbTestFallbackMethod(
        value: Boolean,
        exception: Exception
    ): Boolean {
        logger.info("${exception.message} 서킷 브레이커 작동")
        return when (value) {
            true -> true
            false -> false
        }
    }
}
```



이상으로 서킷 브레이커 코드를 작성하였다.



### Test

이제 정상작동하는지 확인하기 위해 테스트 코드를 작성하였다.

```kotlin
import com.example.demo.common.config.circuitBreaker.CircuitBreakerConfiguration
import io.github.resilience4j.circuitbreaker.CircuitBreakerRegistry
import org.assertj.core.api.Assertions.assertThat
import org.junit.jupiter.api.DisplayName
import org.junit.jupiter.api.Test
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.test.context.SpringBootTest
import org.springframework.test.context.ActiveProfiles


@SpringBootTest
@ActiveProfiles("test")
class CircuitBreakerServiceTest @Autowired constructor(
    private val service: CircuitBreakerService,
    private val registry: CircuitBreakerRegistry
) {
    @Test
    @DisplayName("value=true면 정상 리턴(true)")
    fun returnsTrueWhenValueIsTrue() {
        val result = service.circuitBreakerTest(true)
        assertThat(result).isTrue()
    }

    @Test
    @DisplayName("value=false면 예외→폴백 호출되어 false 리턴")
    fun returnsFalseViaFallbackWhenValueIsFalse() {
        val result = service.circuitBreakerTest(false)

        assertThat(result).isFalse()
    }

}
```





### Test 실행

![스크린샷 2025-10-16 오후 11.51.24](/Users/chanwoo/Library/Application Support/typora-user-images/스크린샷 2025-10-16 오후 11.51.24.png)







## 참고 문헌

- [https://techblog.woowahan.com/15694](https://techblog.woowahan.com/15694)

- [https://resilience4j.readme.io/docs/circuitbreaker](https://resilience4j.readme.io/docs/circuitbreaker)
- [https://blog.hwahae.co.kr/all/tech/14541](https://blog.hwahae.co.kr/all/tech/14541)
- [https://learn.microsoft.com/ko-kr/azure/architecture/patterns/circuit-breaker](https://learn.microsoft.com/ko-kr/azure/architecture/patterns/circuit-breaker)
- [https://oliveyoung.tech/2023-08-31/circuitbreaker-inventory-squad](https://oliveyoung.tech/2023-08-31/circuitbreaker-inventory-squad)